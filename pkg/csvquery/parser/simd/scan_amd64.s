//go:build amd64
// +build amd64

#include "textflag.h"

// func checkAVX2() bool
TEXT ·checkAVX2(SB), NOSPLIT, $0-1
	MOVQ $7, AX
	MOVQ $0, CX
	CPUID
	SHRQ $5, BX
	ANDQ $1, BX
	MOVB BX, ret+0(FP)
	RET

DATA mask_quote<>+0(SB)/8, $0x2222222222222222
DATA mask_quote<>+8(SB)/8, $0x2222222222222222
DATA mask_comma<>+0(SB)/8, $0x2C2C2C2C2C2C2C2C
DATA mask_comma<>+8(SB)/8, $0x2C2C2C2C2C2C2C2C
DATA mask_newline<>+0(SB)/8, $0x0A0A0A0A0A0A0A0A
DATA mask_newline<>+8(SB)/8, $0x0A0A0A0A0A0A0A0A

GLOBL mask_quote<>(SB), RODATA, $16
GLOBL mask_comma<>(SB), RODATA, $16
GLOBL mask_newline<>(SB), RODATA, $16

TEXT ·scanAVX2(SB), NOSPLIT, $0-48
	MOVQ data+0(FP), SI
	MOVQ len+8(FP), DX
	MOVQ quotes+16(FP), DI
	MOVQ commas+24(FP), CX
	MOVQ newlines+32(FP), R8

	MOVQ $0x22, AX
	VPBROADCASTB AX, Y1
	MOVQ $0x2C, AX
	VPBROADCASTB AX, Y2
	MOVQ $0x0A, AX
	VPBROADCASTB AX, Y3

	MOVQ $0, R9

loop_avx2:
	CMPQ DX, $64
	JL done_avx2

	VMOVDQU (SI), Y0
	VPCMPEQB Y1, Y0, Y4
	VPMOVMSKB Y4, AX
	VPCMPEQB Y2, Y0, Y4
	VPMOVMSKB Y4, BX
	VPCMPEQB Y3, Y0, Y4
	VPMOVMSKB Y4, R10

	VMOVDQU 32(SI), Y0
	VPCMPEQB Y1, Y0, Y4
	VPMOVMSKB Y4, R11
	SHLQ $32, R11
	ORQ R11, AX
	MOVQ AX, (DI)

	VPCMPEQB Y2, Y0, Y4
	VPMOVMSKB Y4, R11
	SHLQ $32, R11
	ORQ R11, BX
	MOVQ BX, (CX)

	VPCMPEQB Y3, Y0, Y4
	VPMOVMSKB Y4, R11
	SHLQ $32, R11
	ORQ R11, R10
	MOVQ R10, (R8)

	ADDQ $64, SI
	ADDQ $8, DI
	ADDQ $8, CX
	ADDQ $8, R8
	SUBQ $64, DX
	ADDQ $64, R9
	JMP loop_avx2

done_avx2:
	MOVQ R9, ret+40(FP)
	VZEROUPPER
	RET

TEXT ·scanSSE42(SB), NOSPLIT, $0-48
	MOVQ data+0(FP), SI
	MOVQ len+8(FP), DX
	MOVQ quotes+16(FP), DI
	MOVQ commas+24(FP), CX
	MOVQ newlines+32(FP), R8

	MOVOU mask_quote<>(SB), X1
	MOVOU mask_comma<>(SB), X2
	MOVOU mask_newline<>(SB), X3

	MOVQ $0, R9

loop_sse:
	CMPQ DX, $64
	JL done_sse

	MOVOU (SI), X0
	MOVO  X0, X4; PCMPEQB X1, X4; PMOVMSKB X4, AX
	MOVO  X0, X4; PCMPEQB X2, X4; PMOVMSKB X4, BX
	MOVO  X0, X4; PCMPEQB X3, X4; PMOVMSKB X4, R10

	MOVOU 16(SI), X0
	MOVO  X0, X4; PCMPEQB X1, X4; PMOVMSKB X4, R11
	SHLQ $16, R11; ORQ R11, AX
	MOVO  X0, X4; PCMPEQB X2, X4; PMOVMSKB X4, R11
	SHLQ $16, R11; ORQ R11, BX
	MOVO  X0, X4; PCMPEQB X3, X4; PMOVMSKB X4, R11
	SHLQ $16, R11; ORQ R11, R10

	MOVOU 32(SI), X0
	MOVO  X0, X4; PCMPEQB X1, X4; PMOVMSKB X4, R11
	SHLQ $32, R11; ORQ R11, AX
	MOVO  X0, X4; PCMPEQB X2, X4; PMOVMSKB X4, R11
	SHLQ $32, R11; ORQ R11, BX
	MOVO  X0, X4; PCMPEQB X3, X4; PMOVMSKB X4, R11
	SHLQ $32, R11; ORQ R11, R10

	MOVOU 48(SI), X0
	MOVO  X0, X4; PCMPEQB X1, X4; PMOVMSKB X4, R11
	SHLQ $48, R11; ORQ R11, AX
	MOVO  X0, X4; PCMPEQB X2, X4; PMOVMSKB X4, R11
	SHLQ $48, R11; ORQ R11, BX
	MOVO  X0, X4; PCMPEQB X3, X4; PMOVMSKB X4, R11
	SHLQ $48, R11; ORQ R11, R10

	MOVQ AX, (DI)
	MOVQ BX, (CX)
	MOVQ R10, (R8)

	ADDQ $64, SI
	ADDQ $8, DI
	ADDQ $8, CX
	ADDQ $8, R8
	SUBQ $64, DX
	ADDQ $64, R9
	JMP loop_sse

done_sse:
	MOVQ R9, ret+40(FP)
	RET
